<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
    <style>
        html,body{
            margin: 0;
            width: 100%;
            height: 100%;
        }
        canvas{
            width: 100%;
            height: 100%;
        }


    </style>
</head>
<body>
    
    <canvas id="monSuperCanvas"></canvas>
</body>
<script src="./easeljs.min.js"></script>
<script src="./preloadjs.min.js"></script>
<script src="./soundjs.min.js"></script>
<script>
    
    // loading all assets
    var Q = new createjs.LoadQueue();
    createjs.Sound.alternateExtensions = ["mp3"];
    Q.on("complete",completeLoading,this);
    Q.installPlugin(createjs.Sound);
    Q.addEventListener("complete", doneLoading);
    // Image
    Q.loadManifest([

        {id:"T1",src:"./Asset/Graphique/Tuile/Tuile0/tuile_0_PNG8.png"},
        {id:"T2",src:"./Asset/Graphique/Tuile/Tuile1/tuile_1_PNG8.png"},
        {id:"T3",src:"./Asset/Graphique/Tuile/Tuile2/tuile_2_PNG8.png"},
        {id:"T4",src:"./Asset/Graphique/Tuile/Tuile3/tuile_3_PNG8.png"},
        {id:"T5",src:"./Asset/Graphique/Tuile/Tuile4/tuile_4_PNG8.png"},
        {id:"T6",src:"./Asset/Graphique/Tuile/Tuile5/tuile_5_PNG8.png"},
        {id:"T7",src:"./Asset/Graphique/Tuile/Tuile6/tuile_0_PNG8.png"},
        {id:"T8",src:"./Asset/Graphique/Tuile/Tuile7/tuile_1_PNG8.png"},
        {id:"T9",src:"./Asset/Graphique/Tuile/Tuile8/tuile_2_PNG8.png"},
        {id:"T10",src:"./Asset/Graphique/Tuile/Tuile9/tuile_3_PNG8.png"},
        {id:"T11",src:"./Asset/Graphique/Tuile/Tuile10/tuile_4_PNG8.png"},
        {id:"BouleDeNeigeF1",src:"./Asset/Graphique/Snowball/Snowball_Grande/snowball_grande_1.png"},
        {id:"BouleDeNeigeF2",src:"./Asset/Graphique/Snowball/Snowball_Grande/snowball_grande_2.png"},
        {id:"BouleDeNeigeF3",src:"./Asset/Graphique/Snowball/Snowball_Grande/snowball_grande_3.png"},
        {id:"BouleDeNeigeF4",src:"./Asset/Graphique/Snowball/Snowball_Grande/snowball_grande_4.png"},
        {id:"ObstacleBleu",src:"./Asset/Graphique/Obstacle/obstacle_glace.png"},
        {id:"ObstacleVert",src:"./Asset/Graphique/Obstacle/obstacle_sven.png"},
       {id:"fond",src:"./Asset/Sons/DelhaizeSound/FrozenBGM.ogg"},
       // {id:"boule",src:"./Asset/Sons/DelhaizeSound/GlidingSnowball.ogg"}, 
        {id:"depart",src:"./Asset/Sons/DelhaizeSound/RaceStart.ogg"},
        {id:"fin",src:"./Asset/Sons/DelhaizeSound/RaceEnd.ogg"}
        
    ]);
    

    // variable
    var canvas
    var scene;
    var terrain;
    var vMax = .88;
    var vMin = .05
    var scale;
    // tuile
    var hPosTuile1;
    var hPosTuile2;
    var tuile1;
    var tuile2;
    var idInterval
    var idNextTuile;
    // jeu
    var boolGameBegin=true;
    var ConstImageHeight;
    // objet
    var boule;
    var neige;
    var obstacleL;
    //var ObstacleNumberByTuile = [0,1,2,3,4,5,6,7,8,9]
    var vx = 0;
    // barre
    var barre;
    var avancement;
    vy = 0.22;
    var appelonce = true;
    var idFrame;
    
    //variable lier au décompte et au lancement du timer
    var countdown=3;
    var seconds = 0;
    var min = 0;
    var time=0;
    var score; 
    var decompte;


    
    function doneLoading(event) {
        canvas.onclick = handleClick;
    }
    
    function handleClick() {
		//prevent extra clicks and hide text
		canvas.onclick = null;
		
        console.log("test");

		// indicate the player is now on screen
		createjs.Sound.play("fond");

		
	}
    // var debug
    var debug = 1;
    function completeLoading(event){
        canvas = document.getElementById("monSuperCanvas");
        initGame();
       
    }
    
    function handleFileLoad(event)
    {
        console.log("preload:",event.id,event.src);
    }

    function Animation(){
        // Animation Boule de Neige
        boule.image = Q.getResult("BouleDeNeigeF"+idFrame);
        if(idFrame >3){
            idFrame=1;
        }
        else{
            idFrame++;
        }
    }
    function initGame(){
        // init canevas
        document.addEventListener("keydown", down);
        document.addEventListener("keyup", up);
        canvas.width= window.innerWidth;
        canvas.height= window.innerHeight;
        obstacleL= [];
        barre = new createjs.Shape();
        scene = new createjs.Stage("monSuperCanvas");
        terrain = new createjs.Container();
        neige = new createjs.Container();
        fond = new createjs.Shape();
        avancement = new createjs.Shape();
        //affichage du décompte et du timer
        score = new createjs.Text(min +":"+seconds, "100px Arial", "#000000");
        decompte = new createjs.Text(countdown, "100px Arial", "#000000");
        score.x = canvas.width-250;
        score.y=100;
        score.textBaseline = "alphabetic";
        
        decompte.x = canvas.width/2;
        decompte.y=canvas.height/2;
        decompte.textBaseline = "alphabetic";
       
        // init tuile1
        tuile1 = new createjs.Bitmap(Q.getResult("T1"));
        hPosTuile1 = 0;
        tuile1.scaleX = canvas.width/Q.getResult("T1").width;
        tuile1.scaleY = canvas.height/Q.getResult("T1").height;
        ConstImageHeight = window.innerHeight;

        //init Tuile 2
        tuile2 = new createjs.Bitmap(Q.getResult("T2"));
        tuile2.scaleX = canvas.width/Q.getResult("T2").width;
        tuile2.scaleY = canvas.height/Q.getResult("T2").height;
        hPosTuile2 = -window.innerHeight;
        //console.log(ConstImageHeight);
        idNextTuile=3;

        // init Obstacle Tuile 2
        InitObstacleBleu(obstacleL);
        InitObstacleVert(obstacleL);


        boule = new createjs.Bitmap(Q.getResult("BouleDeNeigeF1"));
        idFrame=2;
        neige.scaleX=.5;
        neige.scaleY=.5;
        boule.setBounds(0,0,Q.getResult("BouleDeNeigeF1").width,Q.getResult("BouleDeNeigeF1").height);
        boule.x = -boule.getBounds().width/2;
        boule.y = -boule.getBounds().height/2
        neige.setBounds(0,0,Q.getResult("BouleDeNeigeF1").width,Q.getResult("BouleDeNeigeF1").height);
        neige.x=canvas.width/2;
        neige.y=canvas.height - boule.getBounds().height;
        neige.addChild(boule);
        // init barre
        barre.graphics.beginFill("rgb(255,0,0)");
        barre.graphics.drawRect(0,0,50,canvas.height);
        barre.graphics.endFill();
        avancement.graphics.beginFill("rgb(0,0,0)");
        avancement.graphics.drawRect(0,0,50,50);
        avancement.graphics.endFill();
        avancement.y = canvas.height-50;
        // adding in scene
        scene.addChild(tuile1);
        scene.addChild(tuile2);
        scene.addChild(neige);
        scene.addChild(terrain);
        scene.addChild(barre);
        scene.addChild(avancement);
        scene.addChild(score);
        scene.addChild(decompte);
        createjs.Sound.play("fond",{interrupt: createjs.Sound.INTERRUPT_ANY, loop: -1, volume: 1});
        // les interval ( timer , animation et update)
        scene.update();
        setInterval(PrepaDepart,1000);
        //
    }
        

    function update(){
        //permet de rafraichir le temps
        //console.log(idNextTuile);
        score.text=min +":"+seconds;
        createjs.Ticker.framerate = 20*(vy/0.88);
        //console.log(createjs.Ticker.framerate);
        if(idNextTuile > 12){
            boolGameBegin = false;
        }
        else{
            // collision bord
            neige.x+=vx;
            if(neige.x<canvas.width/4+neige.getBounds().width/2*neige.scaleX){
                neige.x=canvas.width/4+neige.getBounds().width/2*neige.scaleX;
                if(vy>0.10){
                    vy = vy/2
                }else{
                    vy = 0.05
                }
            }

            if(neige.x>(canvas.width/4)*3-neige.getBounds().width/2*neige.scaleX){
                neige.x=(canvas.width/4)*3-neige.getBounds().width/2*neige.scaleX;
                if(vy>0.10){
                    vy = vy/2
                }else{
                    vy = 0.05
                }
            }
            // collision obstcle bleu
            for(var cpt=0;cpt<obstacleL.length;cpt++){
                if(neige.x-((neige.getBounds().width/2)*neige.scaleX)>obstacleL[cpt].x && neige.x-((neige.getBounds().width/2)*neige.scaleX)<obstacleL[cpt].x+obstacleL[cpt].getBounds().width ||(neige.x+(neige.getBounds().width/2)*neige.scaleX>obstacleL[cpt].x && neige.x+((neige.getBounds().width/2)*neige.scaleX)<obstacleL[cpt].x+obstacleL[cpt].getBounds().width )){
                   if((terrain.y+obstacleL[cpt].y+obstacleL[cpt].getBounds().height>neige.y-(neige.getBounds().height/2)*neige.scaleY && terrain.y+obstacleL[cpt].y+obstacleL[cpt].getBounds().height<neige.y+(neige.getBounds().height/2)*neige.scaleY)||(terrain.y+obstacleL[cpt].y>neige.y-(neige.getBounds().height/2)*neige.scaleY && terrain.y+obstacleL[cpt].y<(neige.y+neige.getBounds().height/2)*neige.scaleY)){
                        terrain.removeChild(obstacleL[cpt]);
                        obstacleL.splice(cpt,1);
                        scene.update();
                        if(vy>0.10){
                            vy = vy/2
                        }else{
                            vy = 0.05
                        }
                    }
                }
            }
            
            //Modification de la taille joueur
            scale = ((100/(vMax-vMin)*(vy-vMin)/2)+50)/100;
            //console.log(scale+"%");
            neige.scaleX = scale;
            neige.scaleY = scale;
            neige.height = (neige.y+neige.getBounds().width)*neige.scaleY;
            neige.width = (neige.x+neige.getBounds().height)*neige.scaleX;
            
            //Vitesse Joueur
            if(vy<vMax){
                vy+=0.001;
            }
            //Terrain
            terrain.y+=vy
            UpdatePositionObstacle(obstacleL,vy);
           
            // tuile 
            hPosTuile1+=vy;
            hPosTuile2+=vy;
            hPosTuile1 = ResetTuileUp(tuile1,hPosTuile1);
            hPosTuile2 = ResetTuileUp(tuile2,hPosTuile2);

            // barre 
            avancement.y-=(vy/10);
            // augmentation de la vitesse
            if(vy<vMax){
                vy+=0.001;
            }
            tuile2.setTransform(0,hPosTuile2,tuile2.scaleX,tuile2.scaleY);
            tuile1.setTransform(0,hPosTuile1,tuile1.scaleX,tuile1.scaleY);
        }
        if(debug == 1){
            console.log(tuile1,tuile2);
            debug = 0;
        }
        // ------------------------------------------------------------------------------------ END GAME -------------------------------------------------------------------------------------------//
        scene.update();
        if(boolGameBegin == false){
            if(appelonce == true){
                createjs.Sound.play("fin");
                alert("Finis en "+time);
                clearInterval(time);
                appelonce = false;
                SendPagePartage();
            }
            
        }
        // ------------------------------------------------------------------------------------ END GAME -------------------------------------------------------------------------------------------//
    }
    /*--------------------------------------------------------------------------------------------------RESET TUILE ZONE---------------------------------------------------------------------------------*/
    function ResetTuileUp(tuile,positionH){
        if(positionH> canvas.height){

            positionH = -ConstImageHeight;
            if(idNextTuile > 11){
                tuile.image = Q.getResult("T1");
            }
            else{
                tuile.image = Q.getResult("T"+idNextTuile);
            }
            idNextTuile++;
        }
        return positionH;
    }
    /*--------------------------------------------------------------------------------------------------RESET TUILE ZONE---------------------------------------------------------------------------------*/
    /*--------------------------------------------------------------------------------------------------INPUT USER ZONE---------------------------------------------------------------------------------*/
    // Movement Function 
    function down(e){
            switch(e.keyCode){
                case 37:
                    vx=-2.2;
                    break;
                case 39:
                    vx=2.2;
                    break;
                }

        }
        
    function up(e){
            switch(e.keyCode){
                case 37:
                    vx=0;
                    break;
                case 39:
                    vx=0;
                    break;
                }
        }
    
    /*--------------------------------------------------------------------------------------------------INPUT USER ZONE---------------------------------------------------------------------------------*/
    /*--------------------------------------------------------------------------------------------------TIMER ZONE---------------------------------------------------------------------------------*/
    //lance le timer
        function Depart()
        {
            createjs.Ticker.on("tick",Animation)
            createjs.Ticker.interval = 25;
            createjs.Ticker.framerate = 20*(vy/0.88);
            idInterval = window.setInterval(update,1);
            time = setInterval(function() 
            {
                seconds++;
                if (seconds >= 60){
                
                    min++;
                    seconds=0;
                    //console.log(min+ " "+seconds);
                }
            }, 1000);
        }
        
        //fait le décompte du temps et lance la fonction Depart
        function PrepaDepart()
        {
            if(countdown==3)
            {
                createjs.Sound.play("depart");
            }
            countdown--;
            scene.update();
            if(countdown<0)
            {
                //Depart();
                scene.removeChild(decompte);
            }
            if(countdown==-1)
            {
                Depart();
            }
            if(countdown>-1)
            {
                decompte.text=countdown; 
                  
            }
            
        }
        /*--------------------------------------------------------------------------------------------------TIMER ZONE---------------------------------------------------------------------------------*/
        /*--------------------------------------------------------------------------------------------------OBSTACLE ZONE---------------------------------------------------------------------------------*/
        function InitObstacleBleu(obs){
            var l = [0,0,0,2,2,2,1,3,3,6]
            var ObsPosX = [25,75,50,75,25,75,50,25,25,30,25,50,0,25,75,25,75,25,75];
            var ObsPosY = [35,70,25,50,15,75,50,15,40,50,20,50,0,25,50,75,25,50,75];
            var a = 0;
            var b = 0;
            for(var i=0;i<l.length;i++){
                for(var j=0;j<l[i];j++){
                    console.log("l et i" ,i,j, a, b);
                    var obstcleBleu = new createjs.Bitmap(Q.getResult("ObstacleBleu"));
                    var posY = -canvas.height*i + ObsPosY[a]*canvas.height/100;
                    var posX = ObsPosX[b]*canvas.width/100;
                    obstcleBleu.setTransform(posX-Q.getResult("ObstacleBleu").width/2,posY-Q.getResult("ObstacleBleu").height/2);
                    obstcleBleu.setBounds(obstcleBleu.x,obstcleBleu.y,Q.getResult("ObstacleBleu").width,Q.getResult("ObstacleBleu").height);
                    obs.push(obstcleBleu);
                    terrain.addChild(obstcleBleu);
                    a++;
                    b++;
                }
            }
            //console.log();
        }
        function InitObstacleVert(obs){
            var l = [0,2,3,0,1,2,6,2,3,0];
            var ObsPosX = [30,70,30,50,70,50,50,30,70,30,70,70,30,30,50,75,50,35,30];
            var ObsPosY = [50,75,35,50,65,75,25,70,15,10,75,90,80,40,40,75,10,35,75];
            var a = 0;
            var b = 0;
            for(var i=0;i<l.length;i++){
                for(var j=0;j<l[i];j++){
                    var obstacleVert = new createjs.Bitmap(Q.getResult("ObstacleVert"));
                    posX = ObsPosX[a]*canvas.width/100;
                    posY = -canvas.height*i  + ObsPosY[b]*canvas.height/100;
                    obstacleVert.setTransform(posX-Q.getResult("ObstacleVert").width/2,posY-Q.getResult("ObstacleVert").height/2);
                    obstacleVert.setBounds(obstacleVert.x,obstacleVert.y,Q.getResult("ObstacleVert").width,Q.getResult("ObstacleVert").height);
                    obs.push(obstacleVert);
                    terrain.addChild(obstacleVert);
                    a++;
                    b++;
                }
            }
           

        
        }
        function UpdatePositionObstacle(obstacleL,vitesse){
            for(var i;i<obstacleL.length;i++){
                obstacleL[i].y += vitesse;
            }
        }


        /*--------------------------------------------------------------------------------------------------OBSTACLE ZONE---------------------------------------------------------------------------------*/
        //(partagefp.php)
        /*-------------------------------------------------------------------------------------------------- PARTAGE AVEC AUTRE PAGE -----------------------------------------------------------------*/

        function SendPagePartage(){
            var request =  new XMLHttpRequest();
            request.open("POST","./partageFB.php",true);
            request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
            var data = min+":"+seconds;
            request.send(data);
            window.location.replace("./partageFB.php");

        }


        /*-------------------------------------------------------------------------------------------------- PARTAGE AVEC AUTRE PAGE -----------------------------------------------------------------*/
</script>
</html>